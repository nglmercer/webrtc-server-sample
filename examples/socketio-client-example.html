<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente SocketIO-like WebSocket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        
        input, button, select {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            margin: 10px 0;
        }
        .message {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 3px;
        }
        .message.system { background-color: #e2e3e5; }
        .message.chat { background-color: #d1ecf1; }
        .message.private { background-color: #f8d7da; }
        .message.error { background-color: #f5c6cb; color: #721c24; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .stats {
            font-size: 12px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üöÄ Cliente SocketIO-like WebSocket</h1>
    
    <div class="container">
        <h3>Conexi√≥n</h3>
        <div id="status" class="status disconnected">Desconectado</div>
        <input type="text" id="serverUrl" value="ws://localhost:8080" placeholder="URL del servidor">
        <input type="text" id="username" value="" placeholder="Tu nombre de usuario">
        <button id="connectBtn" onclick="connect()">Conectar</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Desconectar</button>
        <button onclick="getStats()">Obtener Estad√≠sticas</button>
    </div>

    <div class="grid">
        <div class="container">
            <h3>Salas</h3>
            <input type="text" id="roomName" placeholder="Nombre de la sala">
            <button onclick="joinRoom()" id="joinRoomBtn" disabled>Unirse a Sala</button>
            <button onclick="leaveRoom()" id="leaveRoomBtn" disabled>Salir de Sala</button>
            <button onclick="getRoomUsers()" id="getRoomUsersBtn" disabled>Ver Usuarios</button>
            <div id="currentRooms">Salas actuales: Ninguna</div>
        </div>

        <div class="container">
            <h3>Mensajes</h3>
            <div class="messages" id="messages"></div>
            <input type="text" id="messageInput" placeholder="Escribe un mensaje..." onkeypress="handleMessageKeyPress(event)">
            <button onclick="sendMessage()" id="sendMessageBtn" disabled>Enviar a Sala</button>
            <br>
            <input type="text" id="privateTargetId" placeholder="ID del destinatario">
            <button onclick="sendPrivateMessage()" id="sendPrivateBtn" disabled>Mensaje Privado</button>
        </div>
    </div>

    <div class="container">
        <h3>Funciones Especiales</h3>
        <button onclick="ping()" id="pingBtn" disabled>Ping</button>
        <input type="text" id="globalMessage" placeholder="Mensaje global">
        <input type="text" id="adminKey" placeholder="Clave admin" value="admin123">
        <button onclick="globalBroadcast()" id="globalBtn" disabled>Broadcast Global</button>
    </div>

    <div class="container">
        <h3>Informaci√≥n</h3>
        <div id="info" class="stats">Socket ID: No conectado</div>
        <div id="statsInfo" class="stats"></div>
    </div>

    <script>
        let socket = null;
        let socketId = null;
        let currentRooms = new Set();
        let username = '';

        function updateStatus(status, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            statusEl.className = `status ${className}`;
        }

        function addMessage(message, type = 'system') {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.innerHTML = `<small>${new Date().toLocaleTimeString()}</small><br>${message}`;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('joinRoomBtn').disabled = !connected;
            document.getElementById('leaveRoomBtn').disabled = !connected;
            document.getElementById('getRoomUsersBtn').disabled = !connected;
            document.getElementById('sendMessageBtn').disabled = !connected;
            document.getElementById('sendPrivateBtn').disabled = !connected;
            document.getElementById('pingBtn').disabled = !connected;
            document.getElementById('globalBtn').disabled = !connected;
        }

        function updateInfo() {
            document.getElementById('info').textContent = 
                `Socket ID: ${socketId || 'No conectado'} | Usuario: ${username || 'An√≥nimo'}`;
            document.getElementById('currentRooms').textContent = 
                `Salas actuales: ${currentRooms.size > 0 ? Array.from(currentRooms).join(', ') : 'Ninguna'}`;
        }

        function connect() {
            const url = document.getElementById('serverUrl').value;
            username = document.getElementById('username').value || `Usuario-${Date.now()}`;
            
            if (socket) {
                socket.close();
            }

            updateStatus('Conectando...', 'connecting');
            
            try {
                socket = new WebSocket(url);

                socket.onopen = function() {
                    updateStatus('Conectado', 'connected');
                    updateButtons(true);
                    addMessage('‚úÖ Conectado al servidor');
                };

                socket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data.event, data.payload);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                        addMessage(`‚ùå Error parsing message: ${error.message}`, 'error');
                    }
                };

                socket.onclose = function(event) {
                    updateStatus('Desconectado', 'disconnected');
                    updateButtons(false);
                    socketId = null;
                    currentRooms.clear();
                    updateInfo();
                    addMessage(`üîå Desconectado (${event.code}: ${event.reason || 'Sin raz√≥n'})`);
                };

                socket.onerror = function(error) {
                    updateStatus('Error de conexi√≥n', 'disconnected');
                    addMessage(`‚ùå Error de conexi√≥n: ${error.message || 'Error desconocido'}`, 'error');
                };

            } catch (error) {
                updateStatus('Error', 'disconnected');
                addMessage(`‚ùå Error al conectar: ${error.message}`, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.close(1000, 'User disconnect');
            }
        }

        function sendToServer(event, ...payload) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ event, payload }));
            } else {
                addMessage('‚ùå No hay conexi√≥n con el servidor', 'error');
            }
        }

        function handleServerMessage(event, payload) {
            switch (event) {
                case 'welcome':
                    const welcomeData = payload[0];
                    socketId = welcomeData.socketId;
                    addMessage(`üéâ ${welcomeData.message}`);
                    updateInfo();
                    break;

                case 'joined-room':
                    const joinData = payload[0];
                    currentRooms.add(joinData.room);
                    addMessage(`üè† ${joinData.message} (${joinData.usersInRoom} usuarios)`);
                    updateInfo();
                    break;

                case 'left-room':
                    const leaveData = payload[0];
                    currentRooms.delete(leaveData.room);
                    addMessage(`üö™ ${leaveData.message}`);
                    updateInfo();
                    break;

                case 'user-joined':
                    const userJoinData = payload[0];
                    addMessage(`üëã ${userJoinData.username} se uni√≥ a ${userJoinData.room}`);
                    break;

                case 'user-left':
                    const userLeaveData = payload[0];
                    addMessage(`üëã Usuario ${userLeaveData.socketId} sali√≥ de ${userLeaveData.room}`);
                    break;

                case 'user-disconnected':
                    const disconnectData = payload[0];
                    addMessage(`üîå Usuario ${disconnectData.socketId} se desconect√≥ de ${disconnectData.room}`);
                    break;

                case 'chat-message':
                    const chatData = payload[0];
                    addMessage(`üí¨ <strong>${chatData.username}</strong> en ${chatData.room}: ${chatData.message}`, 'chat');
                    break;

                case 'private-message':
                    const privateData = payload[0];
                    addMessage(`üîí <strong>Privado de ${privateData.fromUsername}</strong>: ${privateData.message}`, 'private');
                    break;

                case 'private-message-sent':
                    const sentData = payload[0];
                    addMessage(`üì§ Mensaje privado enviado a ${sentData.toSocketId}`, 'private');
                    break;

                case 'global-announcement':
                    const globalData = payload[0];
                    addMessage(`üì¢ <strong>ANUNCIO GLOBAL</strong>: ${globalData.message}`, 'system');
                    break;

                case 'stats':
                    const statsData = payload[0];
                    displayStats(statsData);
                    break;

                case 'room-users':
                    const roomUsersData = payload[0];
                    displayRoomUsers(roomUsersData);
                    break;

                case 'pong':
                    const pongData = payload[0];
                    addMessage(`üèì Pong recibido (${Date.now() - pongData.timestamp}ms)`);
                    break;

                case 'error':
                    const errorData = payload[0];
                    addMessage(`‚ùå Error: ${errorData.message} (${errorData.code || 'UNKNOWN'})`, 'error');
                    break;

                default:
                    addMessage(`üì® Evento desconocido: ${event}`, 'system');
                    console.log('Unknown event:', event, payload);
            }
        }

        function joinRoom() {
            const room = document.getElementById('roomName').value.trim();
            if (room) {
                sendToServer('join-room', { room, username });
                document.getElementById('roomName').value = '';
            }
        }

        function leaveRoom() {
            const room = document.getElementById('roomName').value.trim();
            if (room) {
                sendToServer('leave-room', { room });
                document.getElementById('roomName').value = '';
            }
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            const room = document.getElementById('roomName').value.trim();
            
            if (message && room) {
                sendToServer('chat-message', { room, message, username });
                document.getElementById('messageInput').value = '';
            } else {
                addMessage('‚ùå Necesitas especificar sala y mensaje', 'error');
            }
        }

        function sendPrivateMessage() {
            const message = document.getElementById('messageInput').value.trim();
            const targetId = document.getElementById('privateTargetId').value.trim();
            
            if (message && targetId) {
                sendToServer('private-message', { targetSocketId: targetId, message, username });
                document.getElementById('messageInput').value = '';
            } else {
                addMessage('‚ùå Necesitas especificar destinatario y mensaje', 'error');
            }
        }

        function ping() {
            sendToServer('ping');
        }

        function globalBroadcast() {
            const message = document.getElementById('globalMessage').value.trim();
            const adminKey = document.getElementById('adminKey').value.trim();
            
            if (message) {
                sendToServer('global-broadcast', { message, adminKey });
                document.getElementById('globalMessage').value = '';
            }
        }

        function getStats() {
            sendToServer('get-stats');
        }

        function getRoomUsers() {
            const room = document.getElementById('roomName').value.trim();
            if (room) {
                sendToServer('get-room-users', { room });
            }
        }

        function displayStats(stats) {
            const statsHtml = `
                <strong>Estad√≠sticas del Servidor:</strong><br>
                üë• Usuarios totales: ${stats.totalUsers}<br>
                üè† Salas totales: ${stats.totalRooms}<br>
                üìä Salas: ${Object.entries(stats.rooms).map(([room, count]) => `${room}(${count})`).join(', ') || 'Ninguna'}
            `;
            document.getElementById('statsInfo').innerHTML = statsHtml;
            addMessage('üìä Estad√≠sticas actualizadas');
        }

        function displayRoomUsers(data) {
            const usersHtml = data.users.map(user => 
                `${user.socketId} (${user.isAlive ? 'üü¢' : 'üî¥'})`
            ).join(', ');
            addMessage(`üë• Usuarios en ${data.room}: ${usersHtml || 'Ninguno'}`);
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Inicializaci√≥n
        updateButtons(false);
        updateInfo();
        addMessage('üîß Cliente iniciado. Conecta al servidor para comenzar.');
    </script>
</body>
</html>