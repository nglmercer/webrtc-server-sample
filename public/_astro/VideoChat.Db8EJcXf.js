import{m as T,u as j,d as K,a as F,b as O}from"./index.DbwJzG8L.js";import{M as P}from"./MaterialIcon.CkThZV9C.js";import{a as V}from"./apiConfig.HzAyTi0Q.js";import{_ as z}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{d as D,c as u,a as i,t as f,b as w,F as U,i as N,n as E,h as M,r as A,o as W,H as L,f as q,g as m,I as B}from"./runtime-core.esm-bundler.cWTXz6wy.js";/* empty css                       */const o=T({myId:"",roomId:"",status:"Desconectado",isConnected:!1,isInitiator:!1,isMicEnabled:!0,isCamEnabled:!0,localStream:null,peers:{}});function _(b,c){const g=o.get().peers;o.setKey("peers",{...g,[b]:{stream:null,...g[b]||{},...c}})}function H(b){const c={...o.get().peers};delete c[b],o.setKey("peers",c)}const J=D({__name:"VideoChat",setup(b,{expose:c}){c();const g=new URLSearchParams(window.location.search),a=g.get("userId")||`user_${Math.random().toString(36).substring(2,5)}`,h=g.get("roomId")||"default-room",C=g.get("mode")==="listen",l=j(o),d=A(null);let n,r;W(async()=>{o.set({myId:a,roomId:h,status:"Inicializando...",isMicEnabled:!C,isCamEnabled:!C,isConnected:!1,isInitiator:!1,localStream:null,peers:{}}),await x(),p(),v(),r.connect(),L(()=>l.value.localStream,async e=>{await B(),d.value&&e&&(d.value.srcObject=e)},{immediate:!0})}),q(()=>{console.log("[CLEANUP] Desmontando componente. Cerrando conexiones..."),n&&n.closeAllConnections(),r&&r.disconnect(),l.value.localStream?.getTracks().forEach(e=>e.stop())});async function x(){if(C){console.log("Modo oyente, no se solicitará media.");return}try{const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});o.setKey("localStream",e),d.value&&(d.value.srcObject=e)}catch(e){console.error("Error al obtener media:",e),o.setKey("status","Error de media. Revisa permisos.")}}function p(){n=K({onSignalNeeded:(e,t)=>{console.log(`[WebRTC] Enviando señal a ${e}`),r.sendSignal(e,t)},onRemoteStreamAdded:(e,t)=>{console.log(`[WebRTC] Stream recibido de ${e}`),_(e,{stream:t})},onConnectionStateChange:(e,t)=>{console.log(`[WebRTC] Estado de conexión con ${e} cambió a: ${t}`),_(e,{status:t})}}),l.value.localStream&&n.setLocalStream(l.value.localStream)}function v(){const e=V.getFullUrl();F(e),r=O({userId:a,roomId:h},{onConnect:()=>{o.setKey("status","Conectado a señalización. Uniéndose a la sala..."),r.checkPresence(t=>{o.setKey("isInitiator",!t),r.openOrJoinRoom(!t,s=>{o.setKey("isConnected",!0),o.setKey("status",`Conectado a la sala ${h}`),console.log(`[Signaling] ${t?"Unido":"Abierto"} a la sala. Respuesta:`,s),t&&r.sendNewParticipationRequest(h)})})},onDisconnect:()=>{o.setKey("status","Desconectado"),o.setKey("isConnected",!1)},onMessage:async({message:t,sender:s})=>{if(console.log(`[Signaling] Mensaje recibido de ${s}:`,t),!s){console.log("No hay sender",s,t);return}if(t.newParticipationRequest)console.log(`[Signaling] ${s} solicita unirse. Creando oferta...`),_(s,{}),await n.createOffer(s);else if(t.isWebRTCSignal){const y=t.signal;y.type==="offer"?(console.log(`[Signaling] Oferta recibida de ${s}. Creando respuesta...`),_(s,{}),await n.handleOffer(s,y)):y.type==="answer"?(console.log(`[Signaling] Respuesta recibida de ${s}.`),await n.handleAnswer(s,y)):y.candidate&&(console.log(`[Signaling] Candidato ICE recibido de ${s}.`),await n.addIceCandidate(s,y.candidate))}},onUserDisconnected:t=>{console.log(`[Signaling] Usuario ${t} se ha desconectado.`),n.closeConnection(t),H(t)},onRoomOwnerChanged:t=>{console.log(`[Signaling] El nuevo dueño de la sala es ${t}`)}})}function k(){const e=!l.value.isMicEnabled;o.setKey("isMicEnabled",e),n.toggleMic(e)}function I(){const e=!l.value.isCamEnabled;o.setKey("isCamEnabled",e),n.toggleCam(e)}function R(e,t){e&&(e.srcObject=t)}const S={params:g,userId:a,roomId:h,isListener:C,state:l,localVideo:d,get webrtc(){return n},set webrtc(e){n=e},get signaling(){return r},set signaling(e){r=e},initializeMedia:x,initializeWebRTCManager:p,initializeSignalingChannel:v,handleToggleMic:k,handleToggleCam:I,setVideoRef:R,MaterialIcon:P};return Object.defineProperty(S,"__isScriptSetup",{enumerable:!1,value:!0}),S}}),$={class:"flex flex-col h-screen mx-auto p-4 font-sans text-white bg-gray-900"},G={class:"p-4 border-b border-gray-700 text-center"},Q={class:"text-2xl font-bold"},X={class:"text-sm text-gray-400"},Y={class:"flex-grow p-4 my-4 bg-gray-800/50 rounded-lg grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto"},Z={key:0,class:"relative bg-black rounded-lg overflow-hidden shadow-lg"},ee={ref:"localVideo",class:"w-full h-full object-cover",autoplay:"",playsinline:"",muted:""},te={class:"absolute bottom-0 left-0 bg-black/50 px-2 py-1 text-sm rounded-tr-lg"},ae={key:1,class:"absolute inset-0 flex items-center justify-center text-gray-400"},oe={class:"absolute bottom-0 left-0 bg-black/50 px-2 py-1 text-sm rounded-tr-lg"},ne={key:1,class:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-gray-500"},se={class:"p-4 border-t border-gray-700 flex justify-center items-center space-x-4"};function ie(b,c,g,a,h,C){return m(),u("div",$,[i("header",G,[i("h1",Q,"Sala de Video: "+f(a.state.roomId),1),i("p",X,"Tu ID: "+f(a.state.myId)+" | Estado: "+f(a.state.status),1)]),i("main",Y,[a.state.localStream?(m(),u("div",Z,[i("video",ee,null,512),i("div",te,f(a.state.myId)+" (Tú) ",1)])):w("",!0),(m(!0),u(U,null,N(a.state.peers,(l,d)=>(m(),u("div",{key:d,class:"relative bg-black rounded-lg overflow-hidden shadow-lg"},[l.stream?(m(),u("video",{key:0,ref_for:!0,ref:n=>a.setVideoRef(n,l.stream),class:"w-full h-full object-cover",autoplay:"",playsinline:""},null,512)):(m(),u("div",ae," Conectando con "+f(d)+"... ("+f(l.status)+") ",1)),i("div",oe,f(d),1)]))),128)),Object.keys(a.state.peers).length===0&&a.state.isConnected?(m(),u("div",ne,c[0]||(c[0]=[i("p",null,"Estás solo en la sala.",-1),i("p",{class:"text-xs"},"Comparte el enlace para que otros se unan.",-1)]))):w("",!0)]),i("footer",se,[i("button",{onClick:a.handleToggleMic,class:E(["flex items-center justify-center w-14 h-14 rounded-full text-white font-bold transition-colors duration-200",a.state.isMicEnabled?"bg-blue-600 hover:bg-blue-700":"bg-red-600 hover:bg-red-700"])},[M(a.MaterialIcon,{icon:a.state.isMicEnabled?"mic":"mic_off",customSize:"24px",weight:"font-medium"},null,8,["icon"])],2),i("button",{onClick:a.handleToggleCam,class:E(["flex items-center justify-center w-14 h-14 rounded-full text-white font-bold transition-colors duration-200",a.state.isCamEnabled?"bg-blue-600 hover:bg-blue-700":"bg-red-600 hover:bg-red-700"])},[M(a.MaterialIcon,{icon:a.state.isCamEnabled?"videocam":"videocam_off",customSize:"24px",weight:"font-medium"},null,8,["icon"])],2)])])}const fe=z(J,[["render",ie]]);export{fe as default};
