import{m as M,u as O,d as P,a as T,b as N}from"./index.C1EMOFIg.js";import{M as U}from"./MaterialIcon.DnTI76Rh.js";import{U as W,f as D}from"./gridConfigs.CKRb8s7C.js";import{a as z}from"./apiConfig.nx_Al2Mg.js";import{_ as L}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{d as G,c as f,o as m,a as i,t as b,h as p,b as C,L as q,n as K,r as j,e as B,f as J,M as H,N as Q,g as X}from"./runtime-core.esm-bundler.DFbp6Gf0.js";/* empty css                       */import"./runtime-dom.esm-bundler.Bg557htM.js";const n=M({myId:"",roomId:"",status:"Desconectado",isConnected:!1,isInitiator:!1,isAudioEnabled:!0,isVideoEnabled:!0,isScreenSharing:!1,localStream:null,peers:{}});function x(S,r){const g=n.get().peers;n.setKey("peers",{...g,[S]:{stream:null,...g[S]||{},...r}})}function k(S){const r={...n.get().peers};delete r[S],n.setKey("peers",r)}const Y=G({__name:"ScreenShareVideo",setup(S,{expose:r}){r();const g=typeof window<"u"?new URLSearchParams(window.location.search):new URLSearchParams(""),t=g.get("userId")||`user_${Math.random().toString(36).substring(2,5)}`,u=g.get("roomId")||"default-room",d=O(n),s=j(null),_=j(null);let l,c;const v=D,w=B(()=>{const e=[d.value.myId];return Object.keys(d.value.peers).forEach(a=>{e.includes(a)||e.push(a)}),e});J(async()=>{n.set({myId:t,roomId:u,status:"Inicializando...",isAudioEnabled:!1,isVideoEnabled:!1,isScreenSharing:!1,isConnected:!1,isInitiator:!1,localStream:null,peers:{}}),y(),E(),c.connect(),H(()=>d.value.localStream,async e=>{await Q(),s.value&&e&&(s.value.srcObject=e)},{immediate:!0})}),X(()=>{console.log("[CLEANUP] Desmontando componente. Cerrando conexiones..."),l&&l.closeAllConnections(),c&&c.disconnect(),d.value.localStream?.getTracks().forEach(e=>e.stop())});function y(){l=P({onSignalNeeded:(e,a)=>{console.log(`[WebRTC] Enviando se√±al a ${e}`),c.sendSignal(e,a)},onConnectionStateChange:(e,a)=>{console.log(`[WebRTC] Estado de conexi√≥n con ${e} cambi√≥ a: ${a}`),x(e,{status:a})},onScreenShareStarted:(e,a)=>{console.log("[WebRTC] Screen sharing iniciado desde:",e),e==="screen"?(n.setKey("isScreenSharing",!0),n.setKey("localStream",a)):x(e,{stream:a})},onScreenShareStopped:e=>{console.log("[WebRTC] Screen sharing detenido desde:",e),e==="screen"?(n.setKey("isScreenSharing",!1),n.setKey("localStream",null)):k(e)},onDataChannelMessage:(e,a)=>{console.log(`[WebRTC] Mensaje de data channel de ${e}:`,a);try{const o=JSON.parse(a);o.type==="screen-metadata"&&console.log(`[WebRTC] Metadatos de screen sharing de ${e}:`,o)}catch{}}}),d.value.localStream}function E(){const e=z.getFullUrl();T(e),c=N({userId:t,roomId:u},{onConnect:()=>{n.setKey("status","Conectado a se√±alizaci√≥n. Uni√©ndose a la sala..."),c.checkPresence(a=>{n.setKey("isInitiator",!a),c.openOrJoinRoom(!a,o=>{n.setKey("isConnected",!0),n.setKey("status",`Conectado a la sala ${u}`),console.log(`[Signaling] ${a?"Unido":"Abierto"} a la sala. Respuesta:`,o),a&&(c.sendNewParticipationRequest(u),setTimeout(()=>{c.sendNewParticipationRequest(u)},1e3))})})},onDisconnect:()=>{n.setKey("status","Desconectado"),n.setKey("isConnected",!1)},onMessage:async({message:a,sender:o})=>{if(console.log(`[Signaling] Mensaje recibido de ${o}:`,a),!o){console.log("No hay sender",o,a);return}if(a.newParticipationRequest)console.log(`[Signaling] ${o} solicita unirse. Creando oferta...`),x(o,{}),await l.createOffer(o);else if(a.isWebRTCSignal){const h=a.signal;h.type==="offer"?(console.log(`[Signaling] Oferta recibida de ${o}. Creando respuesta...`),x(o,{}),await l.handleOffer(o,h)):h.type==="answer"?(console.log(`[Signaling] Respuesta recibida de ${o}.`),await l.handleAnswer(o,h)):h.candidate&&(console.log(`[Signaling] Candidato ICE recibido de ${o}.`),await l.addIceCandidate(o,h.candidate))}},onUserDisconnected:a=>{console.log(`[Signaling] Usuario ${a} se ha desconectado.`),l.closeConnection(a),k(a)},onRoomOwnerChanged:a=>{console.log(`[Signaling] El nuevo due√±o de la sala es ${a}`)}})}async function R(){try{if(d.value.isScreenSharing)l.stopScreenShare(),s.value&&(s.value.srcObject=null),n.setKey("localStream",null);else{n.setKey("status","Iniciando screen sharing...");const e=await l.startScreenShare();n.setKey("localStream",e),s.value&&(s.value.srcObject=e)}}catch(e){console.error("Error al toggle screen share:",e),n.setKey("status","Error al compartir pantalla")}}function A(){const e=!d.value.isAudioEnabled;n.setKey("isAudioEnabled",e)}function V(){const e=!d.value.isVideoEnabled;n.setKey("isVideoEnabled",e)}function F(e,a){e&&(e.srcObject=a)}const I={params:g,userId:t,roomId:u,state:d,localVideo:s,videoGrid:_,get webrtc(){return l},set webrtc(e){l=e},get signaling(){return c},set signaling(e){c=e},gridConfig:v,videoList:w,initializeWebRTCManager:y,initializeSignalingChannel:E,toggleScreenShare:R,toggleAudio:A,toggleVideo:V,setVideoRef:F,MaterialIcon:U,UnifiedVideoGrid:W};return Object.defineProperty(I,"__isScriptSetup",{enumerable:!1,value:!0}),I}}),Z={class:"flex flex-col h-screen mx-auto p-4 font-sans text-white bg-gray-900"},$={class:"p-4 border-b border-gray-700 text-center"},ee={class:"text-2xl font-bold"},te={class:"text-sm text-gray-400"},ae={class:"flex-grow p-4 my-4 bg-gray-800/50 rounded-lg overflow-y-auto"},ne={class:"relative bg-black rounded-lg overflow-hidden shadow-lg h-full"},oe=["srcObject"],se={key:2,class:"absolute inset-0 flex items-center justify-center text-gray-400 bg-gray-800"},ie={class:"text-center"},re={class:"text-xs"},le={key:3,class:"absolute inset-0 flex items-center justify-center text-gray-400 bg-gray-800"},ce={key:4,class:"absolute top-2 right-2 px-2 py-1 bg-red-600 text-white text-xs rounded-full animate-pulse"},de={key:0,class:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-gray-500"},ge={class:"p-4 border-t border-gray-700 flex justify-center items-center space-x-4"};function ue(S,r,g,t,u,d){return m(),f("div",Z,[i("header",$,[i("h1",ee,"Screen Sharing: "+b(t.state.roomId),1),i("p",te,"Tu ID: "+b(t.state.myId)+" | Estado: "+b(t.state.status),1)]),i("main",ae,[p(t.UnifiedVideoGrid,{videos:t.videoList,config:t.gridConfig,ref:"videoGrid"},{video:q(({video:s,index:_,config:l,isActive:c,isFocused:v,isMain:w})=>[i("div",ne,[s.id===t.state.myId&&t.state.localStream?(m(),f("video",{key:0,ref:"localVideo",class:"w-full h-full object-cover",autoplay:"",controls:"",playsinline:"",muted:"",srcObject:t.state.localStream},null,8,oe)):s.id!==t.state.myId&&t.state.peers[s.id]?.stream?(m(),f("video",{key:1,ref:y=>t.setVideoRef(y,t.state.peers[s.id].stream),class:"w-full h-full object-cover",autoplay:"",controls:"",playsinline:""},null,512)):s.id!==t.state.myId&&!t.state.peers[s.id]?.stream?(m(),f("div",se,[i("div",ie,[r[0]||(r[0]=i("div",{class:"animate-pulse mb-2"},"üîÑ",-1)),i("p",null,"Conectando con "+b(s.id)+"...",1),i("p",re,"("+b(t.state.peers[s.id]?.status||"Iniciando...")+")",1)])])):s.id===t.state.myId&&!t.state.localStream?(m(),f("div",le,[i("div",{class:"text-center"},[r[1]||(r[1]=i("div",{class:"mb-2"},"üñ•Ô∏è",-1)),r[2]||(r[2]=i("p",null,"Screen sharing desactivado",-1)),i("button",{onClick:t.toggleScreenShare,class:"mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"}," Compartir Pantalla ")])])):C("",!0),s.id===t.state.myId&&t.state.isScreenSharing?(m(),f("div",ce," üñ•Ô∏è SHARING ")):C("",!0)])]),_:1},8,["videos","config"]),t.videoList.length<=1&&t.state.isConnected?(m(),f("div",de,r[3]||(r[3]=[i("p",null,"Est√°s solo en la sala.",-1),i("p",{class:"text-xs"},"Comparte el enlace para que otros se unan y vean tu pantalla.",-1)]))):C("",!0)]),i("footer",ge,[i("button",{onClick:t.toggleScreenShare,class:K(["flex items-center justify-center w-14 h-14 rounded-full text-white font-bold transition-colors duration-200",t.state.isScreenSharing?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700"])},[p(t.MaterialIcon,{icon:t.state.isScreenSharing?"stop_screen_share":"screen_share",customSize:"24px",weight:"font-medium"},null,8,["icon"])],2),i("button",{onClick:t.toggleAudio,class:K(["flex items-center justify-center w-14 h-14 rounded-full text-white font-bold transition-colors duration-200",t.state.isAudioEnabled?"bg-blue-600 hover:bg-blue-700":"bg-gray-600 hover:bg-gray-700"]),title:"Incluir audio del sistema en el screen sharing"},[p(t.MaterialIcon,{icon:t.state.isAudioEnabled?"mic":"mic_off",customSize:"24px",weight:"font-medium"},null,8,["icon"])],2)])])}const Ce=L(Y,[["render",ue]]);export{Ce as default};
