import{m as V,u as O,e as U,a as P,b as D}from"./index.C1EMOFIg.js";import{M as z}from"./MaterialIcon.DnTI76Rh.js";import{U as A,f as L}from"./gridConfigs.CKRb8s7C.js";import{a as N}from"./apiConfig.nx_Al2Mg.js";import{_ as W}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{d as B,c as m,o as u,a as n,t as _,h as w,b as f,L as G,n as T,r as K,e as q,f as J,M as H,N as Q,g as X}from"./runtime-core.esm-bundler.DFbp6Gf0.js";/* empty css                       */import"./runtime-dom.esm-bundler.Bg557htM.js";const i=V({myId:"",roomId:"",status:"Desconectado",isConnected:!1,isInitiator:!1,isMicEnabled:!0,isCamEnabled:!0,localStream:null,peers:{}});function x(b,c){const g=i.get().peers;i.setKey("peers",{...g,[b]:{stream:null,...g[b]||{},...c}})}function Y(b){const c={...i.get().peers};delete c[b],i.setKey("peers",c)}const Z=B({__name:"VideoChat",setup(b,{expose:c}){c();const g=new URLSearchParams(window.location.search),e=g.get("userId")||`user_${Math.random().toString(36).substring(2,5)}`,y=g.get("roomId")||"default-room",r=O(i),s=K(null),M=K(null);let l,d;const C=L,v=q(()=>{const t=[r.value.myId];return Object.keys(r.value.peers).forEach(a=>{t.includes(a)||t.push(a)}),t});J(async()=>{i.set({myId:e,roomId:y,status:"Inicializando...",isMicEnabled:!1,isCamEnabled:!1,isConnected:!1,isInitiator:!1,localStream:null,peers:{}}),E(),k(),d.connect(),H(()=>r.value.localStream,async t=>{await Q(),s.value&&t&&(s.value.srcObject=t)},{immediate:!0})}),X(()=>{console.log("[CLEANUP] Desmontando componente. Cerrando conexiones..."),l&&l.closeAllConnections(),d&&d.disconnect(),r.value.localStream?.getTracks().forEach(t=>t.stop())});async function S(){try{const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});i.setKey("localStream",t),s.value&&(s.value.srcObject=t)}catch(t){console.error("Error al obtener media:",t),i.setKey("status","Error de media. Revisa permisos.")}}function E(){l=U({onSignalNeeded:(t,a)=>{console.log(`[WebRTC] Enviando seÃ±al a ${t}`),d.sendSignal(t,a)},onRemoteStreamAdded:(t,a)=>{console.log(`[WebRTC] Stream recibido de ${t}`),x(t,{stream:a})},onConnectionStateChange:(t,a)=>{console.log(`[WebRTC] Estado de conexiÃ³n con ${t} cambiÃ³ a: ${a}`),x(t,{status:a})}}),r.value.localStream&&l.setLocalStream(r.value.localStream)}function k(){const t=N.getFullUrl();P(t),d=D({userId:e,roomId:y},{onConnect:()=>{i.setKey("status","Conectado a seÃ±alizaciÃ³n. UniÃ©ndose a la sala..."),d.checkPresence(a=>{i.setKey("isInitiator",!a),d.openOrJoinRoom(!a,o=>{i.setKey("isConnected",!0),i.setKey("status",`Conectado a la sala ${y}`),console.log(`[Signaling] ${a?"Unido":"Abierto"} a la sala. Respuesta:`,o),a&&d.sendNewParticipationRequest(y)})})},onDisconnect:()=>{i.setKey("status","Desconectado"),i.setKey("isConnected",!1)},onMessage:async({message:a,sender:o})=>{if(console.log(`[Signaling] Mensaje recibido de ${o}:`,a),!o){console.log("No hay sender",o,a);return}if(a.newParticipationRequest)console.log(`[Signaling] ${o} solicita unirse. Creando oferta...`),x(o,{}),await l.createOffer(o);else if(a.isWebRTCSignal){const h=a.signal;h.type==="offer"?(console.log(`[Signaling] Oferta recibida de ${o}. Creando respuesta...`),x(o,{}),await l.handleOffer(o,h)):h.type==="answer"?(console.log(`[Signaling] Respuesta recibida de ${o}.`),await l.handleAnswer(o,h)):h.candidate&&(console.log(`[Signaling] Candidato ICE recibido de ${o}.`),await l.addIceCandidate(o,h.candidate))}},onUserDisconnected:a=>{console.log(`[Signaling] Usuario ${a} se ha desconectado.`),l.closeConnection(a),Y(a)},onRoomOwnerChanged:a=>{console.log(`[Signaling] El nuevo dueÃ±o de la sala es ${a}`)}})}async function p(t){try{return await navigator.mediaDevices.getUserMedia(t)}catch(a){return console.error("Error al obtener media:",a),i.setKey("status","Error de media. Revisa permisos o dispositivos."),null}}async function j(){const t=!r.value.isMicEnabled;if(i.setKey("isMicEnabled",t),t){const a=await p({audio:!0});if(a){const o=a.getAudioTracks()[0];r.value.localStream?r.value.localStream.addTrack(o):i.setKey("localStream",new MediaStream([o])),await l.addMediaTrack(o),l.toggleMic(!0)}else i.setKey("isMicEnabled",!1)}else l.toggleMic(!1)}async function F(){const t=!r.value.isCamEnabled;if(i.setKey("isCamEnabled",t),t){const a=await p({video:!0});if(a){const o=a.getVideoTracks()[0];r.value.localStream?r.value.localStream.addTrack(o):i.setKey("localStream",new MediaStream([o])),await l.addMediaTrack(o),l.toggleCam(!0)}else i.setKey("isCamEnabled",!1)}else l.toggleCam(!1)}function R(t,a){t&&(t.srcObject=a)}const I={params:g,userId:e,roomId:y,state:r,localVideo:s,videoGrid:M,get webrtc(){return l},set webrtc(t){l=t},get signaling(){return d},set signaling(t){d=t},gridConfig:C,videoList:v,initializeMedia:S,initializeWebRTCManager:E,initializeSignalingChannel:k,getLocalMedia:p,handleToggleMic:j,handleToggleCam:F,setVideoRef:R,MaterialIcon:z,UnifiedVideoGrid:A};return Object.defineProperty(I,"__isScriptSetup",{enumerable:!1,value:!0}),I}}),$={class:"flex flex-col h-screen mx-auto p-4 font-sans text-white bg-gray-900"},ee={class:"p-4 border-b border-gray-700 text-center"},te={class:"text-2xl font-bold"},ae={class:"text-sm text-gray-400"},oe={class:"flex-grow p-4 my-4 bg-gray-800/50 rounded-lg overflow-y-auto"},se={class:"relative bg-black rounded-lg overflow-hidden shadow-lg h-full"},ne=["srcObject"],ie={key:2,class:"absolute inset-0 flex items-center justify-center text-gray-400 bg-gray-800"},le={class:"text-center"},re={class:"text-xs"},ce={key:3,class:"absolute inset-0 flex items-center justify-center text-gray-400 bg-gray-800"},de={class:"absolute bottom-0 left-0 bg-black/70 px-3 py-2 text-sm rounded-tr-lg backdrop-blur-sm"},me={class:"flex items-center space-x-2"},ue={class:"font-medium"},ge={class:"flex space-x-1"},fe={key:0,class:"text-red-400"},be={key:1,class:"text-red-400"},ye={key:2,class:"text-blue-400"},he={key:3,class:"text-yellow-400"},_e={key:4,class:"absolute top-2 right-2 w-3 h-3 bg-green-500 rounded-full animate-pulse"},xe={key:0,class:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-gray-500"},Ce={class:"p-4 border-t border-gray-700 flex justify-center items-center space-x-4"};function ve(b,c,g,e,y,r){return u(),m("div",$,[n("header",ee,[n("h1",te,"Sala de Video: "+_(e.state.roomId),1),n("p",ae,"Tu ID: "+_(e.state.myId)+" | Estado: "+_(e.state.status),1)]),n("main",oe,[w(e.UnifiedVideoGrid,{videos:e.videoList,config:e.gridConfig,ref:"videoGrid"},{video:G(({video:s,index:M,config:l,isActive:d,isFocused:C,isMain:v})=>[n("div",se,[s.id===e.state.myId&&e.state.localStream?(u(),m("video",{key:0,ref:"localVideo",class:"w-full h-full object-cover",autoplay:"",playsinline:"",muted:"",srcObject:e.state.localStream},null,8,ne)):s.id!==e.state.myId&&e.state.peers[s.id]?.stream?(u(),m("video",{key:1,ref:S=>e.setVideoRef(S,e.state.peers[s.id].stream),class:"w-full h-full object-cover",autoplay:"",playsinline:""},null,512)):s.id!==e.state.myId&&!e.state.peers[s.id]?.stream?(u(),m("div",ie,[n("div",le,[c[0]||(c[0]=n("div",{class:"animate-pulse mb-2"},"ğŸ”„",-1)),n("p",null,"Conectando con "+_(s.id)+"...",1),n("p",re,"("+_(e.state.peers[s.id]?.status||"Iniciando...")+")",1)])])):s.id===e.state.myId&&!e.state.localStream?(u(),m("div",ce,c[1]||(c[1]=[n("div",{class:"text-center"},[n("div",{class:"mb-2"},"ğŸ“¹"),n("p",null,"CÃ¡mara desactivada")],-1)]))):f("",!0),n("div",de,[n("div",me,[n("span",ue,_(s.id===e.state.myId?`${s.id} (TÃº)`:s.id),1),n("div",ge,[s.id===e.state.myId&&!e.state.isMicEnabled?(u(),m("span",fe,"ğŸ”‡")):f("",!0),s.id===e.state.myId&&!e.state.isCamEnabled?(u(),m("span",be,"ğŸ“¹")):f("",!0),v?(u(),m("span",ye,"ğŸ‘‘")):f("",!0),C?(u(),m("span",he,"â­")):f("",!0)])])]),s.id===e.state.myId&&e.state.isMicEnabled?(u(),m("div",_e)):f("",!0)])]),_:1},8,["videos","config"]),e.videoList.length<=1&&e.state.isConnected?(u(),m("div",xe,c[2]||(c[2]=[n("p",null,"EstÃ¡s solo en la sala.",-1),n("p",{class:"text-xs"},"Comparte el enlace para que otros se unan.",-1)]))):f("",!0)]),n("footer",Ce,[n("button",{onClick:e.handleToggleMic,class:T(["flex items-center justify-center w-14 h-14 rounded-full text-white font-bold transition-colors duration-200",e.state.isMicEnabled?"bg-blue-600 hover:bg-blue-700":"bg-red-600 hover:bg-red-700"])},[w(e.MaterialIcon,{icon:e.state.isMicEnabled?"mic":"mic_off",customSize:"24px",weight:"font-medium"},null,8,["icon"])],2),n("button",{onClick:e.handleToggleCam,class:T(["flex items-center justify-center w-14 h-14 rounded-full text-white font-bold transition-colors duration-200",e.state.isCamEnabled?"bg-blue-600 hover:bg-blue-700":"bg-red-600 hover:bg-red-700"])},[w(e.MaterialIcon,{icon:e.state.isCamEnabled?"videocam":"videocam_off",customSize:"24px",weight:"font-medium"},null,8,["icon"])],2)])])}const Ke=W(Z,[["render",ve]]);export{Ke as default};
