import{v as t,r as K,s as C}from"./store.DiYwYFjM.js";import{u as F,c as A,a as R,b as V}from"./index.C1EMOFIg.js";import{a as k}from"./apiConfig.nx_Al2Mg.js";import{M as O}from"./MaterialIcon.DnTI76Rh.js";import{_ as P}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{d as I,c as b,o as p,a as c,t as m,n as x,b as N,F as U,i as D,h as $,r as T,f as j,g as B}from"./runtime-core.esm-bundler.DFbp6Gf0.js";/* empty css                       */const L=I({__name:"VoiceChat",setup(M,{expose:v}){v();const h=new URLSearchParams(window.location.search),s=h.get("userId")||`user_${Math.random().toString(36).substr(2,5)}`,g=h.get("roomId")||"default-room",_=h.get("mode")!=="speak",n=F(t),f=T(null);let r,d;j(async()=>{if(console.log(`[INIT] Montando componente para ${s} en sala ${g}`),t.set({myId:s,roomId:g,status:"Inicializando...",isConnected:!1,isInitiator:!1,isMicEnabled:!1,localStream:null,peers:{}}),_)t.setKey("status","Modo escucha. Haz clic en el micrófono para hablar.");else try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0}});t.setKey("localStream",e),t.setKey("isMicEnabled",!0),t.setKey("status","Micrófono listo. Conectando...")}catch(e){console.error("Error al obtener micrófono:",e),t.setKey("status","ERROR: Se necesita permiso para el micrófono.");return}if(r=A({onSignalNeeded:(e,o)=>{d.sendSignal(e,o)},onRemoteStreamAdded:(e,o)=>{S(e,o)},onConnectionStateChange:(e,o)=>{console.log(`[WebRTC] Estado de conexión con ${e}: ${o}`),o==="connected"?(C(e,{status:"connected"}),t.setKey("status",`Conectado a ${e}.`)):["disconnected","failed","closed"].includes(o)&&n.value.peers[e]?.status!=="disconnected"&&(t.setKey("status",`Conexión con ${e} perdida.`),y(e))},onPeerDisconnected:e=>{console.log(`[WebRTC] Peer ${e} disconnected`),y(e)}}),n.value.localStream)try{await r.setLocalStream(n.value.localStream),r.toggleMic(n.value.isMicEnabled),console.log("[VoiceChat] Stream local configurado correctamente")}catch(e){console.error("[VoiceChat] Error al configurar stream local:",e),t.setKey("status","Error al configurar el audio local.")}const a=k.getFullUrl();console.log(`[DEBUG] Creando SignalingChannel para conectar a: ${a}`),R(a),d=V({userId:s,roomId:g},{onConnect:()=>{t.setKey("isConnected",!0),t.setKey("status","Conectado. Verificando sala..."),d.checkPresence(async e=>{const o=!e;t.setKey("isInitiator",o),d.openOrJoinRoom(o,i=>{if(i.error)t.setKey("status",`Error al unirse: ${i.error}`);else{const u=o?"Sala creada. Esperando a otros...":"Unido a la sala. Conectando con pares...";t.setKey("status",u),o||(console.log("[INIT] No soy iniciador. Anunciando mi presencia..."),d.sendNewParticipationRequest(g))}})})},onDisconnect:()=>{t.setKey("isConnected",!1),t.setKey("status","Desconectado del servidor. Recarga la página."),r.closeAllConnections()},onMessage:async({extra:e,message:o})=>{const i=o.sender;if(i!==s){if(n.value.peers[i]&&n.value.peers[i].status,console.log(`[Signal] Procesando mensaje de '${i}':`,o),o.newParticipationRequest)console.log(`[Signal] Nuevo usuario '${i}' ha entrado. Como ya estaba en la sala, YO le llamo.`),C(i,{status:"negotiating"}),await r.createOffer(i);else if(o.isWebRTCSignal){const{signal:u}=o;u.type==="offer"?(console.log(`[Signal] Oferta recibida de '${i}'. Aceptando y respondiendo.`),C(i,{status:"negotiating"}),await r.handleOffer(i,u)):u.type==="answer"?(console.log(`[Signal] Respuesta recibida de '${i}'.`),await r.handleAnswer(i,u)):u.candidate&&await r.addIceCandidate(i,u.candidate)}}},onUserDisconnected:e=>{n.value.peers[e]&&(t.setKey("status",`Usuario ${e} se fue.`),y(e))},onRoomOwnerChanged:e=>{const o=e===s;t.setKey("isInitiator",o),o&&t.setKey("status","¡Ahora eres el dueño de la sala!")}}),d.connect()}),B(()=>{console.warn("[CLEANUP] Desmontando componente. Cerrando conexiones."),n.value.localStream?.getTracks().forEach(a=>a.stop()),r?.closeAllConnections(),d?.disconnect()});async function E(){const a=!n.value.isMicEnabled;if(a&&!n.value.localStream){t.setKey("status","Solicitando acceso al micrófono...");try{console.log("[VoiceChat] Habilitando micrófono dinámicamente. Peers conectados:",Object.keys(n.value.peers).length);const l=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0}});t.setKey("localStream",l),await r.setLocalStream(l),r.toggleMic(!0),t.setKey("isMicEnabled",!0),t.setKey("status","Micrófono activado. Ahora puedes hablar."),console.log("[VoiceChat] Micrófono habilitado dinámicamente y configurado correctamente")}catch(l){console.error("[VoiceChat] Error al habilitar micrófono:",l),t.setKey("status","Error: No se pudo acceder al micrófono.");return}}else!a&&n.value.localStream?(t.setKey("isMicEnabled",!1),r.toggleMic(!1),t.setKey("status","Micrófono desactivado.")):n.value.localStream&&(t.setKey("isMicEnabled",a),r.toggleMic(a),t.setKey("status",a?"Micrófono activado.":"Micrófono desactivado."))}function S(a,l){if(!f.value||document.getElementById(`audio-${a}`))return;console.log(`[UI] Creando elemento de audio para ${a}`);const o=document.createElement("audio");o.id=`audio-${a}`,o.srcObject=l,o.autoplay=!0,f.value.appendChild(o)}function y(a){r.closeConnection(a),K(a);const l=document.getElementById(`audio-${a}`);l&&(l.remove(),console.log(`[UI] Elemento de audio para ${a} eliminado.`))}const w={params:h,userId:s,roomId:g,isListener:_,state:n,remoteAudioContainer:f,get webrtc(){return r},set webrtc(a){r=a},get signaling(){return d},set signaling(a){d=a},toggleMicrophone:E,handleRemoteStream:S,handleUserDisconnected:y,MaterialIcon:O};return Object.defineProperty(w,"__isScriptSetup",{enumerable:!1,value:!0}),w}}),z={class:"flex flex-col h-screen max-w-2xl mx-auto p-4 font-sans text-white bg-gray-900"},W={class:"p-4 border-b border-gray-700 text-center"},q={class:"text-2xl font-bold"},H={class:"text-sm text-gray-400"},G={class:"flex-grow p-4 my-4 bg-gray-800/50 rounded-lg overflow-y-auto"},J={class:"text-lg font-semibold mb-4 border-b border-gray-600 pb-2"},Y={class:"space-y-3"},Q={class:"flex items-center p-3 bg-gray-700 rounded-md"},X={class:"font-medium"},Z={class:"font-medium"},ee={class:"ml-auto text-xs text-gray-400"},te={key:0,class:"text-center text-gray-500 mt-8"},oe={class:"p-4 border-t border-gray-700 flex justify-center items-center"},ae={ref:"remoteAudioContainer",class:"hidden"};function se(M,v,h,s,g,_){return p(),b("div",z,[c("header",W,[c("h1",q,"Sala de Voz: "+m(s.state.roomId),1),c("p",H,"Tu ID: "+m(s.state.myId),1),c("p",{class:x(["mt-2 text-md",s.state.isConnected?"text-green-400":"text-yellow-400"])},m(s.state.status),3)]),c("main",G,[c("h2",J," Participantes ("+m(Object.keys(s.state.peers).filter(n=>s.state.peers[n]?.status==="connected").length+1)+") ",1),c("div",Y,[c("div",Q,[c("span",{class:x(["w-3 h-3 rounded-full mr-3",s.state.isMicEnabled?"bg-green-500":"bg-red-500"])},null,2),c("span",X,m(s.state.myId)+" (Tú)",1)]),(p(!0),b(U,null,D(s.state.peers,(n,f)=>(p(),b("div",{key:f,class:"flex items-center p-3 bg-gray-700 rounded-md"},[c("span",{class:x(["w-3 h-3 rounded-full mr-3",n.status==="connected"?"bg-green-500":"bg-yellow-500 animate-pulse"])},null,2),c("span",Z,m(f),1),c("span",ee,m(n.status),1)]))),128)),Object.keys(s.state.peers).length===0?(p(),b("div",te," Estás solo en la sala. Comparte el enlace para que otros se unan. ")):N("",!0)])]),c("footer",oe,[c("button",{onClick:s.toggleMicrophone,class:x(["flex items-center justify-center w-16 h-16 rounded-full text-white font-bold transition-colors duration-200",s.state.isMicEnabled?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700"])},[$(s.MaterialIcon,{icon:s.state.isMicEnabled?"mic":"mic_off",customSize:"32px",weight:"font-medium"},null,8,["icon"])],2)]),c("div",ae,null,512)])}const me=P(L,[["render",se]]);export{me as default};
