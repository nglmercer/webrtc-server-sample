import{v as n,r as K,s as C}from"./store.CZ5PkM78.js";import{u as R,c as A,a as k,b as I}from"./index.DbwJzG8L.js";import{a as O}from"./apiConfig.HzAyTi0Q.js";import{M as P}from"./MaterialIcon.CkThZV9C.js";import{_ as N}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{d as U,c as p,a as i,t as u,n as _,b as D,F,i as V,h as T,r as $,o as j,f as B,g as x}from"./runtime-core.esm-bundler.cWTXz6wy.js";/* empty css                       */const L=U({__name:"VoiceChat",setup(E,{expose:w}){w();const f=new URLSearchParams(window.location.search),o=f.get("userId")||`user_${Math.random().toString(36).substr(2,5)}`,g=f.get("roomId")||"default-room",b=f.get("mode")==="listen",r=R(n),m=$(null);let c,l;j(async()=>{if(console.log(`[INIT] Montando componente para ${o} en sala ${g}`),n.set({myId:o,roomId:g,status:"Inicializando...",isConnected:!1,isInitiator:!1,isMicEnabled:!b,localStream:null,peers:{}}),b)n.setKey("status","Modo escucha. Conectando...");else try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0}});n.setKey("localStream",e),n.setKey("status","Micrófono listo. Conectando...")}catch(e){console.error("Error al obtener micrófono:",e),n.setKey("status","ERROR: Se necesita permiso para el micrófono.");return}c=A({onSignalNeeded:(e,t)=>{l.sendSignal(e,t)},onRemoteStreamAdded:(e,t)=>{S(e,t)},onConnectionStateChange:(e,t)=>{console.log(`[WebRTC] Estado de conexión con ${e}: ${t}`),t==="connected"?(C(e,{status:"connected"}),n.setKey("status",`Conectado a ${e}.`)):["disconnected","failed","closed"].includes(t)&&r.value.peers[e]?.status!=="disconnected"&&(n.setKey("status",`Conexión con ${e} perdida.`),y(e))},onPeerDisconnected:e=>{console.log(`[WebRTC] Peer ${e} disconnected`),y(e)}}),r.value.localStream&&(c.setLocalStream(r.value.localStream),c.toggleMic(r.value.isMicEnabled));const a=O.getFullUrl();console.log(`[DEBUG] Creando SignalingChannel para conectar a: ${a}`),k(a),l=I({userId:o,roomId:g},{onConnect:()=>{n.setKey("isConnected",!0),n.setKey("status","Conectado. Verificando sala..."),l.checkPresence(async e=>{const t=!e;n.setKey("isInitiator",t),l.openOrJoinRoom(t,s=>{if(s.error)n.setKey("status",`Error al unirse: ${s.error}`);else{const d=t?"Sala creada. Esperando a otros...":"Unido a la sala. Conectando con pares...";n.setKey("status",d),t||(console.log("[INIT] No soy iniciador. Anunciando mi presencia..."),l.sendNewParticipationRequest(g))}})})},onDisconnect:()=>{n.setKey("isConnected",!1),n.setKey("status","Desconectado del servidor. Recarga la página."),c.closeAllConnections()},onMessage:async({extra:e,message:t})=>{const s=t.sender;if(s!==o){if(r.value.peers[s]&&r.value.peers[s].status,console.log(`[Signal] Procesando mensaje de '${s}':`,t),t.newParticipationRequest)console.log(`[Signal] Nuevo usuario '${s}' ha entrado. Como ya estaba en la sala, YO le llamo.`),C(s,{status:"negotiating"}),await c.createOffer(s);else if(t.isWebRTCSignal){const{signal:d}=t;d.type==="offer"?(console.log(`[Signal] Oferta recibida de '${s}'. Aceptando y respondiendo.`),C(s,{status:"negotiating"}),await c.handleOffer(s,d)):d.type==="answer"?(console.log(`[Signal] Respuesta recibida de '${s}'.`),await c.handleAnswer(s,d)):d.candidate&&await c.addIceCandidate(s,d.candidate)}}},onUserDisconnected:e=>{r.value.peers[e]&&(n.setKey("status",`Usuario ${e} se fue.`),y(e))},onRoomOwnerChanged:e=>{const t=e===o;n.setKey("isInitiator",t),t&&n.setKey("status","¡Ahora eres el dueño de la sala!")}}),l.connect()}),B(()=>{console.warn("[CLEANUP] Desmontando componente. Cerrando conexiones."),r.value.localStream?.getTracks().forEach(a=>a.stop()),c?.closeAllConnections(),l?.disconnect()});function M(){if(b)return;const a=!r.value.isMicEnabled;n.setKey("isMicEnabled",a),c.toggleMic(a)}function S(a,h){if(!m.value||document.getElementById(`audio-${a}`))return;console.log(`[UI] Creando elemento de audio para ${a}`);const t=document.createElement("audio");t.id=`audio-${a}`,t.srcObject=h,t.autoplay=!0,m.value.appendChild(t)}function y(a){c.closeConnection(a),K(a);const h=document.getElementById(`audio-${a}`);h&&(h.remove(),console.log(`[UI] Elemento de audio para ${a} eliminado.`))}const v={params:f,userId:o,roomId:g,isListener:b,state:r,remoteAudioContainer:m,get webrtc(){return c},set webrtc(a){c=a},get signaling(){return l},set signaling(a){l=a},toggleMicrophone:M,handleRemoteStream:S,handleUserDisconnected:y,MaterialIcon:P};return Object.defineProperty(v,"__isScriptSetup",{enumerable:!1,value:!0}),v}}),z={class:"flex flex-col h-screen max-w-2xl mx-auto p-4 font-sans text-white bg-gray-900"},W={class:"p-4 border-b border-gray-700 text-center"},q={class:"text-2xl font-bold"},G={class:"text-sm text-gray-400"},J={class:"flex-grow p-4 my-4 bg-gray-800/50 rounded-lg overflow-y-auto"},Y={class:"text-lg font-semibold mb-4 border-b border-gray-600 pb-2"},H={class:"space-y-3"},Q={class:"flex items-center p-3 bg-gray-700 rounded-md"},X={class:"font-medium"},Z={class:"font-medium"},ee={class:"ml-auto text-xs text-gray-400"},te={key:0,class:"text-center text-gray-500 mt-8"},oe={class:"p-4 border-t border-gray-700 flex justify-center items-center"},ae=["disabled"],ne={ref:"remoteAudioContainer",class:"hidden"};function se(E,w,f,o,g,b){return x(),p("div",z,[i("header",W,[i("h1",q,"Sala de Voz: "+u(o.state.roomId),1),i("p",G,"Tu ID: "+u(o.state.myId),1),i("p",{class:_(["mt-2 text-md",o.state.isConnected?"text-green-400":"text-yellow-400"])},u(o.state.status),3)]),i("main",J,[i("h2",Y," Participantes ("+u(Object.keys(o.state.peers).filter(r=>o.state.peers[r]?.status==="connected").length+1)+") ",1),i("div",H,[i("div",Q,[i("span",{class:_(["w-3 h-3 rounded-full mr-3",o.state.isMicEnabled?"bg-green-500":"bg-red-500"])},null,2),i("span",X,u(o.state.myId)+" (Tú)",1)]),(x(!0),p(F,null,V(o.state.peers,(r,m)=>(x(),p("div",{key:m,class:"flex items-center p-3 bg-gray-700 rounded-md"},[i("span",{class:_(["w-3 h-3 rounded-full mr-3",r.status==="connected"?"bg-green-500":"bg-yellow-500 animate-pulse"])},null,2),i("span",Z,u(m),1),i("span",ee,u(r.status),1)]))),128)),Object.keys(o.state.peers).length===0?(x(),p("div",te," Estás solo en la sala. Comparte el enlace para que otros se unan. ")):D("",!0)])]),i("footer",oe,[i("button",{onClick:o.toggleMicrophone,disabled:!o.state.localStream,class:_(["flex items-center justify-center w-16 h-16 rounded-full text-white font-bold transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed",o.state.isMicEnabled?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700"])},[T(o.MaterialIcon,{icon:o.state.isMicEnabled?"mic":"mic_off",customSize:"32px",weight:"font-medium"},null,8,["icon"])],10,ae)]),i("div",ne,null,512)])}const me=N(L,[["render",se]]);export{me as default};
